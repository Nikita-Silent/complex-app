---
description: Docker Compose setup and containerization practices
globs: ["**/Dockerfile", "**/docker-compose.yml", "**/.dockerignore"]
alwaysApply: false
---
# Docker Guidelines

## Docker Compose Structure

### Basic Setup
```yaml
# docker-compose.yml
version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-appdb}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # API Gateway
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/appdb?sslmode=disable
      - TASKS_SERVICE_URL=http://tasks-service:8080
      - NEWS_SERVICE_URL=http://news-service:8080
      - AUTH_SERVICE_URL=http://auth-service:8080
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Auth Service
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/appdb?sslmode=disable
      - PORT=8080
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Tasks Service
  tasks-service:
    build:
      context: ./services/tasks-service
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/appdb?sslmode=disable
      - PORT=8080
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # News Service
  news-service:
    build:
      context: ./services/news-service
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/appdb?sslmode=disable
      - PORT=8080
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # User Service
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/appdb?sslmode=disable
      - PORT=8080
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
```

## Dockerfile for Go Services

### Multi-stage Build
```dockerfile
# ✅ Good: Multi-stage Dockerfile for Go services
# Build stage
FROM golang:1.21-alpine AS builder

WORKDIR /app

# Copy go mod files
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build the application
RUN CGO_ENABLED=0 GOOS=linux go build -o /app/server ./cmd/server

# Final stage
FROM alpine:latest

RUN apk --no-cache add ca-certificates curl

WORKDIR /root/

# Copy binary from builder
COPY --from=builder /app/server .

# Expose port
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1

# Run the binary
CMD ["./server"]
```

### Single Service Dockerfile
```dockerfile
# services/auth-service/Dockerfile
FROM golang:1.21-alpine AS builder

WORKDIR /app

# Copy go mod files
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build
RUN CGO_ENABLED=0 GOOS=linux go build -o server ./cmd/server

FROM alpine:latest
RUN apk --no-cache add ca-certificates curl
WORKDIR /root/
COPY --from=builder /app/server .
EXPOSE 8080
HEALTHCHECK --interval=30s --timeout=10s CMD curl -f http://localhost:8080/health || exit 1
CMD ["./server"]
```

## Dockerfile for Frontend

```dockerfile
# ✅ Good: Frontend Dockerfile with Vite
# Build stage
FROM node:18-alpine AS builder

WORKDIR /app

# Copy package files
COPY package.json package-lock.json ./
RUN npm ci

# Copy source code
COPY . .

# Build
RUN npm run build

# Production stage
FROM nginx:alpine

# Copy built files
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy nginx config
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

## .dockerignore

### Go Services
```dockerignore
# .dockerignore for Go services
*.md
.git
.gitignore
.env
.env.local
*.test.go
*_test.go
coverage.txt
.vscode
.idea
```

### Frontend
```dockerignore
# .dockerignore for frontend
node_modules
npm-debug.log
.env
.env.local
dist
coverage
.vscode
.idea
```

## Environment Variables

### .env.example
```bash
# Database
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=appdb
DATABASE_URL=postgres://postgres:postgres@postgres:5432/appdb?sslmode=disable

# Services
GATEWAY_PORT=8080
AUTH_SERVICE_URL=http://auth-service:8080
TASKS_SERVICE_URL=http://tasks-service:8080
NEWS_SERVICE_URL=http://news-service:8080
USER_SERVICE_URL=http://user-service:8080

# API Keys (if needed)
TELEGRAM_BOT_TOKEN=your_token_here
AUTHENTIK_CLIENT_ID=your_client_id
AUTHENTIK_CLIENT_SECRET=your_client_secret
```

## Health Checks

### Service Health Endpoint
```go
// ✅ Good: Health check endpoint for each service
func (h *Handler) HealthCheck(w http.ResponseWriter, r *http.Request) {
    // Check database connection
    if err := h.db.Exec("SELECT 1").Error; err != nil {
        http.Error(w, "Database unavailable", http.StatusServiceUnavailable)
        return
    }
    
    w.WriteHeader(http.StatusOK)
    json.NewEncoder(w).Encode(map[string]string{
        "status": "healthy",
        "service": "auth-service",
    })
}
```

## Docker Commands

### Development
```bash
# Build and start all services
docker-compose up --build

# Start specific service
docker-compose up gateway

# Start in detached mode
docker-compose up -d

# View logs
docker-compose logs -f gateway
docker-compose logs -f auth-service

# Stop all services
docker-compose down

# Stop and remove volumes
docker-compose down -v
```

### Building Individual Services
```bash
# Build specific service
docker build -t auth-service ./services/auth-service

# Build with tag
docker build -t auth-service:latest ./services/auth-service

# Run individual container
docker run -p 8080:8080 auth-service
```

## Network Configuration

### Service Communication
```yaml
# Services communicate via service names
# Example: gateway can reach auth-service via http://auth-service:8080
services:
  gateway:
    networks:
      - app-network
  
  auth-service:
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
```

## Volume Management

### Database Persistence
```yaml
services:
  postgres:
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
    driver: local
```

### Development Volumes (Optional)
```yaml
# Mount source code for hot reload during development
services:
  auth-service:
    volumes:
      - ./services/auth-service:/app
      - /app/vendor  # Exclude vendor directory
```

## Best Practices

1. **Multi-stage builds** - Use multi-stage builds to reduce image size
2. **Health checks** - Add health checks for all services
3. **Environment variables** - Use environment variables for configuration
4. **.dockerignore** - Exclude unnecessary files from builds
5. **Layer caching** - Order Dockerfile commands to maximize cache hits
6. **Security** - Use non-root user when possible
7. **Dependencies** - Use `depends_on` with health checks
8. **Networks** - Use Docker networks for service communication
9. **Volumes** - Use volumes for persistent data
10. **Documentation** - Document required environment variables
